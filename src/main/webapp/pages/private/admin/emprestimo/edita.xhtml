<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets">
    <h:body>
        <ui:composition template="/pages/private/template.xhtml">
            <ui:define name="conteudo">
                <h:form id="form-user" prependId="false" >
                    <div class="ui-fluid">
                        <p:panel id="panelEmprestimo" header="#{emprestimoControlador.header}">
                            <p:messages id="messagesEmprestimo" showDetail="true" closable="true" autoUpdate="true" />
                            <p:focus context="panelEmprestimo"/>
                            <p:panelGrid id="gridEmprestimo" 
                                         columns="2"
                                         layout="grid"
                                         styleClass="panelgrid-noborder"
                                         style="margin-top: 5px; margin-bottom: 10px"
                                         columnClasses="ui-grid-col-6, ui-grid-col-6">
                                <p:panelGrid columns="2" id="camposEmp"
                                             styleClass="panelgrid-noborder"
                                             layout="grid"
                                             style="margin-top: 5px; margin-bottom: 10px"
                                             columnClasses="ui-grid-col-2, ui-grid-col-10">
                                    <p:outputLabel value="Pessoa: " for="pessoa" />
                                    <p:autoComplete 
                                        readonly="#{emprestimoControlador.visualizar}"
                                        id="pessoa"
                                        var="pessoa" 
                                        forceSelection="true"
                                        completeMethod="#{emprestimoControlador.completaPessoa}" 
                                        converter="#{emprestimoControlador.converterPessoa}"
                                        emptyMessage="Nenhum resultado encontrado"
                                        value="#{emprestimoControlador.emprestimo.pessoa}"
                                        itemValue="#{pessoa.id}" itemLabel="#{pessoa.toString()}">
                                        <p:ajax event="keyup"
                                                update="addExem dtDevolucao"
                                                listener="#{emprestimoControlador.validaDiasDevolucao('Sim')}"/>
                                    </p:autoComplete>
                                    <p:outputLabel value="Obra: " for="obra" />
                                    <p:autoComplete 
                                        id="obra"
                                        var="obra" 
                                        forceSelection="true"
                                        completeMethod="#{emprestimoControlador.completaObra}" 
                                        converter="#{emprestimoControlador.converterObra}"
                                        emptyMessage="Nenhum resultado encontrado"
                                        value="#{emprestimoControlador.publicacaoFiltro}"
                                        itemValue="#{obra.id}" itemLabel="#{obra.toString()}">
                                        <p:ajax event="itemSelect" listener="#{emprestimoControlador.validaQtdEmprestimo()}" />
                                        <p:ajax event="itemUnselect" />
                                        <p:ajax event="keyup" />
                                    </p:autoComplete>
                                    <p:outputLabel value="Exemplar: " for="exemplar" />
                                    <p:autoComplete 
                                        id="exemplar"
                                        var="exemplar" 
                                        forceSelection="true"
                                        completeMethod="#{emprestimoControlador.completaPublicacao}" 
                                        converter="#{emprestimoControlador.converterPublicacao}"
                                        emptyMessage="Nenhum resultado encontrado"
                                        value="#{emprestimoControlador.itemEmprestimo.exemplar}"
                                        itemValue="#{exemplar.id}" itemLabel="#{exemplar.toString()}">

                                        <p:ajax event="itemSelect" 
                                                update="nomeExem addExem"
                                                listener="#{emprestimoControlador.completarExemplar}"/>
                                        <p:ajax event="keyup" 
                                                update="nomeExem addExem"
                                                listener="#{emprestimoControlador.completarExemplar}"/>
                                    </p:autoComplete>

                                    <p:outputLabel/>
                                    <p:inputText readonly="true" value="#{emprestimoControlador.nomeExemplar}" id="nomeExem" />

                                    <p:outputLabel value="Data Devolução: " for="dtDevolucao" />
                                    <p:calendar id="dtDevolucao"
                                                readonly="#{emprestimoControlador.visualizar}" 
                                                value="#{emprestimoControlador.itemEmprestimo.prazo}" 
                                                pattern="dd/MM/yyyy" 
                                                mask="true" >
                                        <p:ajax event="dateSelect" listener="#{emprestimoControlador.onDataPrazoSelect}" />
                                    </p:calendar>
                                </p:panelGrid>
                                <p:dataTable id="tableRes"
                                             var="itemreserva" 
                                             paginator="true"
                                             rows="5"
                                             reflow="true"
                                             resizableColumns="true"
                                             resizeMode="fit"
                                             scrollable="true"
                                             scrollHeight="60"
                                             emptyMessage="Nenhum registro encontrado">
                                    <f:facet name="header">
                                        Reservas Abertas
                                    </f:facet>
                                    <p:column filterStyle="width: auto" filterBy="#" headerText="Publicação">
                                        <h:outputText value="#" />
                                    </p:column>
                                    <p:column filterStyle="width: auto" filterBy="#" headerText="Data Prevista">
                                        <h:outputText value="#" />
                                    </p:column>
                                    <f:facet name="footer">
                                        Total de reservas: .
                                    </f:facet>
                                </p:dataTable>
                            </p:panelGrid>
                            <p:commandButton  
                                actionListener="#{emprestimoControlador.pesquisaEmprestimo}" 
                                id="addExem" 
                                icon="ui-icon-search" 
                                value="Pesquisar" 
                                disabled="#{emprestimoControlador.emprestar == false}" 
                                update="messagesEmprestimo gridEmp addExem"
                                process="@this"
                                title="Realizar Pesquisa"/>

                            <h:panelGrid id="gridEmp" 
                                         columns="2"
                                         styleClass="panelgrid-noborder"
                                         style="margin-top: 5px; margin-bottom: 10px"
                                         columnClasses="ui-grid-col-6, ui-grid-col-6">
                                <p:panel id="exemplares" header="Exemplares Disponiveis">
                                    <p:dataTable id="tableExemDisp" 
                                                 var="exemplares" 
                                                 paginator="true" 
                                                 reflow="true"
                                                 rows="5" 
                                                 resizableColumns="true"
                                                 value="#{emprestimoControlador.exemplaresFiltrados}" 
                                                 emptyMessage="Nenhum registro encontrado">
                                        <p:column width="25">
                                            <h:outputText id="dragIcon" style="text-align: left" styleClass="ui-icon ui-icon-arrow-4" />
                                            <p:draggable for="dragIcon" revert="true" helper="clone"/>
                                        </p:column>
                                        <p:column headerText="Tombo">
                                            <h:outputText value="#{exemplares.tombo}" />
                                        </p:column>
                                        <p:column headerText="Número Exemplar">
                                            <h:outputText value="#{exemplares.numExe}" />
                                        </p:column>
                                        <p:column headerText="Estado Exemplar">
                                            <h:outputText value="#{exemplares.estadoExemplar.descricao}" />
                                        </p:column>
                                    </p:dataTable>
                                </p:panel>
                                <p:panel id="exemplaresSelecionados" header="Exemplares para Emprestimo">
                                    <p:outputPanel id="dropArea">
                                        <h:outputText value="Coloque aqui os exemplares a serem emprestados" rendered="#{empty emprestimoControlador.emprestimo.itemEmprestimo}" style="font-size:16px;" />
                                        <p:dataTable id="tableEmp" 
                                                     var="itememp" 
                                                     paginator="true" 
                                                     reflow="true"
                                                     rows="5" 
                                                     rendered="#{not empty emprestimoControlador.exemplarDrop}"
                                                     resizableColumns="true"
                                                     value="#{emprestimoControlador.exemplarDrop}" 
                                                     emptyMessage="Nenhum registro encontrado">

                                            <p:column headerText="Exemplar">
                                                <h:outputText value="#{itememp.publicacao.titulo}" />
                                            </p:column>

                                            <p:column headerText="Data Emprestimo">
                                                <h:outputText value="#{emprestimoControlador.emprestimo.criacao}">
                                                    <f:convertDateTime locale="pt-br" pattern="dd/MM/yyyy" />
                                                </h:outputText>
                                            </p:column>
                                            <p:column headerText="Data Prazo de Devolução">
                                                <h:outputText value="#{emprestimoControlador.itemEmprestimo.prazo}">
                                                    <f:convertDateTime locale="pt-br" pattern="dd/MM/yyyy" />
                                                </h:outputText>
                                            </p:column>
                                        </p:dataTable>
                                    </p:outputPanel>
                                </p:panel>
                                <p:droppable  for="exemplaresSelecionados" tolerance="touch" activeStyleClass="ui-state-highlight" datasource="tableExemDisp" onDrop="handleDrop">
                                    <p:ajax listener="#{emprestimoControlador.onExemplarDrop}" update="dropArea tableExemDisp addExem" />
                                </p:droppable>
                            </h:panelGrid>
                            <p:separator/>
                            <p:panelGrid id="gridBotoes" columns="2"
                                         layout="grid"
                                         columnClasses="ui-grid-col-6, ui-grid-col-6"
                                         styleClass="panelgrid-noborder">
                                <p:commandButton id="botaoSalvar1" type="button" icon="ui-icon-check" value="Salvar" onclick="PF('salvarEmp').show();"/>
                                <p:commandButton id="botaoCancelar1" process="@this" icon="ui-icon-close" value="Cancelar" action="#{emprestimoControlador.prepararLista()}" update="@form" />

                            </p:panelGrid>
                            <p:dialog responsive="true" dynamic="true" 
                                      header="Imprimir Comprovante?" 
                                      widgetVar="salvarEmp" 
                                      onHide="#{emprestimoControlador.prepararLista()}"
                                      width="350"
                                      resizable="false"
                                      height="100">

                                <p:outputLabel value="Deseja realizar a impressão do comprovante de empréstimo?" />

                                <p:panelGrid id="gridBotoes2" columns="2"
                                             layout="grid"
                                             style="margin-top: 20px"
                                             columnClasses="ui-grid-col-6, ui-grid-col-6"
                                             styleClass="panelgrid-noborder">

                                    <p:commandButton id="botaoSim" 
                                                     ajax="false" 
                                                     actionListener="#{emprestimoControlador.salvar('Sim')}" 
                                                     action="#{comprovanteControlador.emitir()}"
                                                     async="true"
                                                     onclick="PF('salvarEmp').hide();"
                                                     process="@this"
                                                     update="@form"
                                                     icon="ui-icon-check" 
                                                     value="Sim" 
                                                     />

                                    <p:commandButton id="botaoNao" process="@this" 
                                                     icon="ui-icon-close" 
                                                     value="Não" 
                                                     action="#{emprestimoControlador.salvar('Nao')}" 
                                                     update="@form" />
                                </p:panelGrid>
                            </p:dialog>
                        </p:panel>
                    </div>
                </h:form>
            </ui:define>
        </ui:composition>
    </h:body>
</html>

